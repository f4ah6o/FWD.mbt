# Functional Work Design(FWD)

## コンセプトドキュメント

---

## 1. 概要

### FWD とは

> **Domain Modeling Made Functional (DMMF) の思想を「仕事」のドメインに特化し、非開発者でも定義・実行可能にしたフレームワーク**

### 設計思想

| 原則 | 内容 |
|------|------|
| **宣言的 (Declarative)** | 「何をするか」を定義すれば動く |
| **型安全 (Type-Safe)** | 不正な状態遷移をコンパイル時に検出 |
| **GUI 編集可能** | 非開発者が業務を定義・改善できる |
| **実行可能 (Executable)** | 定義からそのまま動くシステムを生成 |

---

## 2. フレームワーク：ESWWRTB

### 7つの概念

| 概念 | 問い | DMMF 対応 |
|------|------|----------|
| **Entity** | 何を扱う？ | Product Type |
| **State** | どんな見え方？ | Activity のグルーピング（ビュー） |
| **Work** | どう変換する？ | Function |
| **Workflow** | どう繋がる？ | Pipeline / Composition |
| **Rule** | どう判断する？ | Decision Function |
| **Transition** | 何が許される？ | Make Illegal States Unrepresentable |
| **Boundary** | 誰と/何と接する？ | I/O at the edges |

### 概念間の関係
下の図はちょっと崩れてる
```
                    Boundary (人/プログラムとの接点)
                    ┌─────────────────────────────────┐
                    │  UI (人)    │  API (プログラム)  │
                    └──────────────────┬──────────────┘
                                       │
        ┌──────────────────────────────▼──────────────────────────────┐
        │                                                             │
        │   Entity ──→ Work ──→ Entity ──→ Work ──→ Entity          │
        │     │          │         │         │         │             │
        │     │     Transition     │    Transition     │             │
        │     │          │         │         │         │             │
        │     └──── Workflow (繋がり) ────────┘         │             │
        │                    │                                        │
        │                   Rule (判断)                               │
        │                                                             │
        └─────────────────────────────────────────────────────────────┘
                                       │
                    ┌──────────────────▼──────────────┐
                    │  State (ユーザー向け抽象表示)    │
                    │  Activity をグルーピング        │
                    └─────────────────────────────────┘
```

---

## 3. 各概念の詳細

### Entity（モノ）

仕事で扱う対象物の構造定義。
```yaml
entity: 申請書
fields:
  - name: id
    type: ID
    auto: true
  - name: title
    type: String
    required: true
  - name: amount
    type: Money
    constraints: ["> 0"]
adapter: Kintone    # どこと繋ぐか (DI)
store: Postgres     # どこに保存するか (DI)
```

**型パラメータ:**

| パラメータ | 役割 | 例 |
|-----------|------|-----|
| `Adapter<T>` | 外部との接続 | Kintone, Slack, ERP, None |
| `Store<T>` | 永続化先 | Postgres, Kintone, S3, EventStore, None |

### Work（変換）

Entity を別の Entity（または別の状態）に変換する仕事の単位。
```yaml
work: 提出する
input: 申請書 @ 起票     # 入力 Entity と Activity
output: 申請書 @ 書類審査  # 出力 Entity と Activity
rules:
  - validation/submit
```

**DMMF 対応:** `Work<In, Out>` = 型付き関数

### Workflow（繋がり）

Work の合成順序。BPMN で表現。
```
申請書 ──→ [提出] ──→ [審査] ──→ ◇ ──→ [承認] ──→ 発注書
                              └──→ [却下] ──→ 終了
```

**型チェック:** 出力の型が次の入力の型と一致することを検証
```
Work<A, B> >> Work<B, C> >> Work<C, D>  ✓ OK
Work<A, B> >> Work<C, D>                ✕ 型エラー
```

### Rule（判断）

分岐や検証のルール。DMN で表現。
```
┌─────────────────────────────────────┐
│ Rule: 承認経路判定                   │
├─────────────────────────────────────┤
│ IF   amount < 10万   THEN 自動承認  │
│ IF   amount < 100万  THEN 課長承認  │
│ IF   amount >= 100万 THEN 部長承認  │
└─────────────────────────────────────┘
```

### Transition（許可される遷移）

不正な状態遷移を防ぐ制約定義。
```yaml
transitions:
  - from: 起票
    to: 書類審査
    via: 提出する
  - from: 書類審査
    to: 承認済み
    via: 承認する
  - from: 書類審査
    to: 却下
    via: 却下する
    
# 暗黙的に禁止
# 起票 → 承認済み ✕
# 却下 → 承認済み ✕
```

### State（抽象状態）

Activity をグルーピングしたユーザー向けビュー。
```yaml
states:
  - name: 下書き
    activities: [起票]
  - name: 審査中
    activities: [書類審査, 上長確認, 差戻し待ち]
  - name: 完了
    activities: [承認済み, 却下]
```

**ユーザーには簡潔に、システムは詳細に**

### Boundary（接点）

外部との入出力。Workflow/Entity から自動導出。

| 対象 | 導出されるもの |
|------|---------------|
| 人 | UI (htmx)、通知、帳票 |
| プログラム | API (OpenAPI)、Webhook |

---

## 4. 責務分離マトリクス

### 凡例

| 記号 | 意味 |
|------|------|
| **太字** | 唯一の定義元/生成元 |
| R | 参照のみ |
| ─ | 無関係 |
| ✕ | 触れてはならない |
| (導出) | 他から自動生成 |
| `<T>` | 型パラメータ (DI) |

### マトリクス

| 構成要素 | Entity | Work | Workflow | Rule | Boundary |
|----------|--------|------|----------|------|----------|
| **─ モノ ─** | | | | | |
| 構造定義 | **型定義** | ─ | ─ | ─ | ─ |
| Adapter | **`<T>`** | ─ | ─ | ─ | 接続実行 |
| Store | **`<T>`** | ─ | ─ | ─ | 永続化実行 |
| **─ 仕事 ─** | | | | | |
| 変換定義 | 入出力型 | **定義** | R | ─ | ─ |
| 実行 | ─ | ─ | **順序制御** | ─ | トリガー |
| **─ 流れ ─** | | | | | |
| Activity | ─ | 含む | **配置** | ─ | ─ |
| Transition | ─ | 制約 | **許可定義** | ─ | ─ |
| State | ─ | ─ | Activity束ねる | ─ | **(導出)** 表示 |
| **─ 判断 ─** | | | | | |
| 条件分岐 | ─ | ─ | 分岐点 | **定義** | ─ |
| 検証 | 対象 | 実行時 | ─ | **定義** | エラー表示 |
| **─ 接点 ─** | | | | | |
| UI | ─ | 操作 | **(導出)** | R | **生成** |
| API | ─ | 呼出 | **(導出)** | R | **生成** |
| 通知 | Adapter`<T>` | トリガー | タイミング | 要否判定 | **配信** |
| **─ 記録 ─** | | | | | |
| 監査ログ | Store`<T>` | 記録 | 記録 | 記録 | 表示 |
| イベント | ─ | **発行** | ─ | ─ | (Observer) |

---

## 5. DMMF 対応表

### 設計・分析（Strategic DDD）

| DMMF | FWD |
|------|-----|
| Ubiquitous Language | **Entity / Work / Workflow / Rule / State / Transition / Boundary** |
| Bounded Context | **Workflow** の境界 |
| Context Maps | Work 間の **Entity 型による接続** |

### モデリング・型設計（Tactical DDD）

| DMMF | FWD |
|------|-----|
| Type-Driven Design | **Entity** の型定義 |
| Make Illegal States Unrepresentable | **Transition** による制約 |
| Domain Events | **Work の出力** / Observer |
| Aggregates | **Entity + Store`<T>`** |

### アーキテクチャ・実装

| DMMF | FWD |
|------|-----|
| Workflow as Function | **Work`<In, Out>`** |
| Push I/O to the edges | **Boundary** に分離 |
| Railway Oriented Programming | **Rule** での分岐 / Result 型 |
| Persistence Ignorance | **Store`<T>`** で抽象化 |
| Anti-Corruption Layer | **Adapter`<T>`** で隔離 |

### 永続化・統合

| DMMF | FWD |
|------|-----|
| CQRS / Event Sourcing | **Store`<EventStore>`** |
| Serialization / DTO | **Boundary** での変換 |

---

## 6. 技術スタック

| 層 | 定義形式 | GUI | 実行基盤 |
|----|---------|-----|---------|
| Entity | Schema (YAML/JSON) | Schema Editor | MoonBit (型生成) |
| Work | BPMN Task (拡張) | BPMN Modeler | MoonBit (関数生成) |
| Workflow | BPMN Process | BPMN Modeler | MoonBit (パイプライン) |
| Rule | DMN | DMN Editor | MoonBit (判定関数) |
| Transition | BPMN + 拡張属性 | BPMN Modeler | MoonBit (型制約) |
| State | YAML (マッピング) | State Editor | UI 生成時に使用 |
| Boundary | (導出) | ─ | htmx / OpenAPI |

---

# Work Designer ツール概要

## 対象ユーザー

**Work Designer** = 業務を定義・改善する立場の人（非開発者含む）

## ツール構成
```
┌─────────────────────────────────────────────────────────────────┐
│                     FWD Designer                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Entity Editor                                          │   │
│  │  ・フィールド定義 (ドラッグ&ドロップ)                    │   │
│  │  ・Adapter/Store 選択                                   │   │
│  │  ・制約の設定                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Workflow Editor (BPMN ベース)                          │   │
│  │  ・Work の配置と接続                                    │   │
│  │  ・Entity の入出力を可視化                              │   │
│  │  ・型エラーをリアルタイム表示                           │   │
│  │  ・Transition の自動検証                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Rule Editor (DMN ベース)                               │   │
│  │  ・Decision Table で条件定義                            │   │
│  │  ・Workflow から参照                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  State Editor                                           │   │
│  │  ・Activity → State のグルーピング                      │   │
│  │  ・ユーザー向け表示名の設定                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Preview & Validate                                     │   │
│  │  ・生成される UI のプレビュー                           │   │
│  │  ・型チェック結果の表示                                 │   │
│  │  ・シミュレーション実行                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 画面イメージ

### Entity Editor
```
┌─────────────────────────────────────────────────────────────────┐
│ Entity: 申請書                                       [保存] [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  フィールド                                                     │
│  ┌────────────┬────────────┬────────┬────────────────────────┐ │
│  │ 名前       │ 型         │ 必須   │ 制約                   │ │
│  ├────────────┼────────────┼────────┼────────────────────────┤ │
│  │ id         │ ID ▼       │ ✓      │ (自動生成)             │ │
│  │ title      │ 文字列 ▼   │ ✓      │ 1文字以上              │ │
│  │ amount     │ 金額 ▼     │ ✓      │ > 0                    │ │
│  │ requester  │ ユーザー ▼ │ ✓      │                        │ │
│  │ [+ 追加]   │            │        │                        │ │
│  └────────────┴────────────┴────────┴────────────────────────┘ │
│                                                                 │
│  接続設定                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Adapter: [ Kintone      ▼ ]  アプリ: [ 購買申請 ▼ ]    │   │
│  │ Store:   [ Postgres     ▼ ]  テーブル: purchase_req     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Workflow Editor
```
┌─────────────────────────────────────────────────────────────────┐
│ Workflow: 購買申請フロー                             [保存] [×] │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────┐                                                     │
│ │ Entity  │  申請書 │ 発注書 │ 検収書                          │
│ │ Work    │  提出 │ 承認 │ 発注作成 │ 検収                     │
│ │ Rule    │  承認判定 │ 金額チェック                           │
│ └─────────┘                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│    申請書           申請書            申請書          発注書    │
│    [起票]          [書類審査]        [承認済み]       [新規]    │
│      │                │                 │              │       │
│      ●───→ [提出] ───→ ◇ ───→ [承認] ───→ [発注作成] ──→ ●    │
│                       │                                        │
│                       └───→ [却下] ───→ ●                      │
│                             申請書                              │
│                             [却下]                              │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│ ✓ 型チェック: すべての遷移が有効です                            │
│ ✓ Transition: 3件の許可された遷移                               │
└─────────────────────────────────────────────────────────────────┘
```

### Rule Editor (DMN)
```
┌─────────────────────────────────────────────────────────────────┐
│ Rule: 承認経路判定                                   [保存] [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  入力: 申請書                                                   │
│  出力: 承認経路                                                 │
│                                                                 │
│  ┌─────────────────┬─────────────────┬─────────────────────┐   │
│  │ 金額            │ 申請者.役職     │ → 承認経路          │   │
│  ├─────────────────┼─────────────────┼─────────────────────┤   │
│  │ < 10万          │ -               │ 自動承認            │   │
│  │ < 100万         │ -               │ 課長承認            │   │
│  │ >= 100万        │ 部長以上        │ 本部長承認          │   │
│  │ >= 100万        │ 部長未満        │ 部長 → 本部長       │   │
│  │ [+ 行追加]      │                 │                     │   │
│  └─────────────────┴─────────────────┴─────────────────────┘   │
│                                                                 │
│  使用箇所: 購買申請フロー.bpmn (承認判定)                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### State Editor
```
┌─────────────────────────────────────────────────────────────────┐
│ State 定義: 申請書                                   [保存] [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ State: 下書き                                           │   │
│  │   └─ Activity: 起票                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ State: 審査中                                           │   │
│  │   ├─ Activity: 書類審査                                 │   │
│  │   ├─ Activity: 上長確認                                 │   │
│  │   └─ Activity: 差戻し待ち                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ State: 完了                                             │   │
│  │   ├─ Activity: 承認済み                                 │   │
│  │   └─ Activity: 却下                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  [+ State 追加]                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Preview & Validate
```
┌─────────────────────────────────────────────────────────────────┐
│ Preview                                              [実行] [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─ 生成 UI プレビュー ─────────────────────────────────────┐  │
│  │                                                          │  │
│  │   購買申請                                               │  │
│  │   ┌──────────────────────────────────────────────────┐  │  │
│  │   │ タイトル: [________________]                     │  │  │
│  │   │ 金額:     [________________] 円                  │  │  │
│  │   │                                                  │  │  │
│  │   │ [提出する]  ← HATEOAS: 現在状態で可能な操作      │  │  │
│  │   └──────────────────────────────────────────────────┘  │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌─ 検証結果 ───────────────────────────────────────────────┐  │
│  │ ✓ Entity: 申請書 - 型定義 OK                             │  │
│  │ ✓ Workflow: 購買申請フロー - すべての遷移が有効          │  │
│  │ ✓ Rule: 承認経路判定 - 網羅性 OK                         │  │
│  │ ✓ Transition: 不正な遷移なし                             │  │
│  │ ✓ Boundary: UI/API 生成可能                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  [デプロイ]  [シミュレーション]  [エクスポート]                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

# 実行可能にするまでの流れ

## 全体アーキテクチャ
```
┌─────────────────────────────────────────────────────────────────┐
│                    Design Time                                  │
│                                                                 │
│   FWD Designer (GUI)                                            │
│     │                                                           │
│     ├─ Entity Editor      → entity.schema.yaml                  │
│     ├─ Workflow Editor    → workflow.bpmn                       │
│     ├─ Rule Editor        → rule.dmn                            │
│     └─ State Editor       → state.yaml                          │
│                                                                 │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Build Time                                   │
│                                                                 │
│   FWD Compiler                                                  │
│     │                                                           │
│     ├─ 型チェック (Transition 検証)                             │
│     │                                                           │
│     ├─ MoonBit コード生成                                       │
│     │   ├─ type 申請書 = { ... }                                │
│     │   ├─ fn 提出する(x: 申請書) -> Result[...]                │
│     │   └─ fn 購買申請フロー(x: 申請書) -> Result[...]          │
│     │                                                           │
│     ├─ Boundary 生成                                            │
│     │   ├─ UI (htmx テンプレート)                               │
│     │   └─ API (OpenAPI スキーマ)                               │
│     │                                                           │
│     └─ Adapter/Store コード生成                                 │
│         ├─ KintoneAdapter                                       │
│         └─ PostgresStore                                        │
│                                                                 │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Runtime                                      │
│                                                                 │
│   FWD Engine (MoonBit → WASM)                                   │
│     │                                                           │
│     ├─ Workflow 実行                                            │
│     │   └─ Work を順番に実行、型で安全性保証                    │
│     │                                                           │
│     ├─ Rule 評価                                                │
│     │   └─ DMN → MoonBit 関数として実行                         │
│     │                                                           │
│     ├─ Boundary                                                 │
│     │   ├─ UI: htmx でサーバー駆動                              │
│     │   └─ API: REST エンドポイント                             │
│     │                                                           │
│     └─ Adapter/Store                                            │
│         ├─ Kintone へ読み書き                                   │
│         └─ Postgres へ永続化                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## ステップ詳細

### Step 1: Design (設計)

Work Designer が GUI で定義

| 成果物 | 形式 | 内容 |
|--------|------|------|
| Entity 定義 | YAML/JSON Schema | フィールド、型、制約、Adapter/Store |
| Workflow 定義 | BPMN (XML) + 拡張 | Work の配置、接続、入出力型 |
| Rule 定義 | DMN (XML) | Decision Table |
| State 定義 | YAML | Activity → State マッピング |

### Step 2: Validate (検証)

FWD Compiler がチェック

| 検証項目 | 内容 |
|----------|------|
| 型チェック | Work の出力型と次の入力型の一致 |
| Transition チェック | 許可されていない遷移がないか |
| Rule 網羅性 | すべてのケースがカバーされているか |
| Entity 整合性 | 参照先が存在するか |

**エラー例:**
```
✕ 型エラー: Work「承認する」の出力「申請書[承認済み]」が
            Work「発注作成」の入力「発注書[新規]」と一致しません
            
✕ Transition エラー: 「起票 → 承認済み」は許可されていません
```

### Step 3: Generate (生成)

コード・アーティファクトを自動生成
```
generated/
├── moonbit/
│   ├── entities/
│   │   ├── 申請書.mbt           # type 定義
│   │   └── 発注書.mbt
│   ├── works/
│   │   ├── 提出する.mbt          # Work 関数
│   │   └── 承認する.mbt
│   ├── workflows/
│   │   └── 購買申請フロー.mbt    # パイプライン
│   ├── rules/
│   │   └── 承認経路判定.mbt      # Decision 関数
│   └── adapters/
│       ├── kintone.mbt
│       └── postgres.mbt
├── boundary/
│   ├── ui/
│   │   ├── 申請フォーム.html
│   │   └── 承認画面.html
│   └── api/
│       └── openapi.yaml
└── wasm/
    └── FWD_runtime.wasm         # コンパイル済み
```

### Step 4: Deploy (配備)
```
┌─────────────────────────────────────────┐
│            FWD Runtime                  │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  WASM Engine (MoonBit compiled) │   │
│  │    ・Workflow 実行              │   │
│  │    ・Rule 評価                  │   │
│  │    ・型安全保証                 │   │
│  └─────────────────────────────────┘   │
│                  │                      │
│     ┌────────────┼────────────┐        │
│     ▼            ▼            ▼        │
│  ┌──────┐   ┌──────┐   ┌──────────┐   │
│  │ htmx │   │ REST │   │ Adapter  │   │
│  │  UI  │   │ API  │   │ /Store   │   │
│  └──────┘   └──────┘   └──────────┘   │
│                                         │
└─────────────────────────────────────────┘
         │            │            │
         ▼            ▼            ▼
      ブラウザ    外部システム   Kintone/DB
```

### Step 5: Execute (実行)
```
1. ユーザーが UI でフォーム入力
          │
          ▼
2. Boundary が Entity を受け取る
          │
          ▼
3. Workflow Engine が Work を実行
   ・型チェック (実行時も)
   ・Rule 評価
   ・Transition 検証
          │
          ▼
4. Adapter/Store が外部と連携
   ・Kintone に保存
   ・Slack に通知
          │
          ▼
5. 次の State に遷移
   ・UI が HATEOAS で更新
   ・可能な操作だけ表示
```

---

## まとめ

| フェーズ | 誰が | 何を | ツール |
|----------|------|------|--------|
| **Design** | Work Designer | 業務を定義 | FWD Designer (GUI) |
| **Validate** | FWD Compiler | 型・遷移を検証 | 自動 |
| **Generate** | FWD Compiler | コードを生成 | 自動 |
| **Deploy** | DevOps | ランタイムを配備 | FWD CLI |
| **Execute** | ユーザー | 仕事を実行 | FWD Runtime + htmx |
| **Improve** | Work Designer | 業務を改善 | FWD Designer (GUI) |

**Design → Validate → Generate → Deploy → Execute → Improve のサイクル**